"""
CRIT-003 FIX: Common handlers for universal callbacks (back, cancel, help)

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–±—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π:
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
- –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞"
- –ü–æ–º–æ—â—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
"""

from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.filters import Command

from utils.logger import logger

# –°–æ–∑–¥–∞–µ–º router –¥–ª—è –æ–±—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
router = Router(name='common')


@router.callback_query(F.data == "back")
async def handle_back(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥'"""
    await callback.answer("‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥")
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å "back" –≤ —Å–≤–æ–∏—Ö –º–æ–¥—É–ª—è—Ö


@router.callback_query(F.data == "cancel")
async def handle_cancel(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–û—Ç–º–µ–Ω–∞'"""
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
    await state.clear()

    await callback.message.edit_text(
        "‚ùå <b>–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ</b>\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    )
    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id} –æ—Ç–º–µ–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ")


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "‚ÑπÔ∏è <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É</b>\n\n"
        "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "<b>–†–∞–∑–¥–µ–ª—ã:</b>\n"
        "‚Ä¢ üìö –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –±–∞–∑–æ–≤—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è\n"
        "‚Ä¢ üíº –û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\n"
        "‚Ä¢ ‚öΩ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –æ—Ç–¥–µ–ª - –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤\n"
        "‚Ä¢ ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º\n\n"
        "<b>–ù–∞–≤–∏–≥–∞—Ü–∏—è:</b>\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º.\n\n"
        "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    )

    await message.answer(help_text)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å")


@router.callback_query(F.data == "help")
async def callback_help(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–∫–∏ '–ü–æ–º–æ—â—å'"""
    help_text = (
        "‚ÑπÔ∏è <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É</b>\n\n"
        "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "<b>–†–∞–∑–¥–µ–ª—ã:</b>\n"
        "‚Ä¢ üìö –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –±–∞–∑–æ–≤—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è\n"
        "‚Ä¢ üíº –û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\n"
        "‚Ä¢ ‚öΩ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –æ—Ç–¥–µ–ª - –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤\n"
        "‚Ä¢ ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º\n\n"
        "<b>–ù–∞–≤–∏–≥–∞—Ü–∏—è:</b>\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º.\n\n"
        "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    )

    await callback.message.edit_text(help_text)
    await callback.answer()
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å")
